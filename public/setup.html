<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Setup Your Site | SiteSprintz</title>
  <link rel="stylesheet" href="theme.css" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .setup-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--spacing-lg);
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(0,0,0,0.08);
      border-radius: 2px;
      margin: var(--spacing-xl) 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary), var(--color-primary-600));
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 50%;
    }
    
    .step-header {
      text-align: center;
      margin: var(--spacing-xl) 0;
    }
    
    .step-title {
      font-size: clamp(1.8rem, 3vw + 1rem, 2.2rem);
      margin: 0;
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-600));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    .step-subtitle {
      font-size: 1.1rem;
      color: var(--color-muted);
      margin: var(--spacing-sm) 0;
    }
    
    .template-grid {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xl);
      margin: var(--spacing-xl) 0;
    }

    .template-tier-card {
      background: linear-gradient(180deg, rgba(15,27,45,0.45), rgba(15,27,45,0.1));
      border: 1px solid rgba(148,163,184,0.22);
      border-radius: calc(var(--radius) + 4px);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-sm);
    }

    .template-tier-header h3 {
      margin: 0;
      font-size: 1.5rem;
      color: white;
    }

    .template-tier-header p {
      margin: var(--spacing-sm) 0 0;
      color: rgba(226,232,240,0.8);
    }

    .template-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
    }
    
    .template-card {
      background: var(--color-surface);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: var(--radius);
      padding: var(--spacing-lg);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .template-plan-badge {
      position: absolute;
      top: var(--spacing-sm);
      left: var(--spacing-sm);
      background: rgba(37,99,235,0.1);
      color: var(--color-primary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
    }
    
    .template-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--template-color);
      transform: scaleX(0);
      transition: transform 0.2s ease;
    }
    
    .template-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: var(--color-primary);
    }
    
    .template-card.selected {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.15);
    }
    
    .template-card.selected::before {
      transform: scaleX(1);
    }

    .template-card.disabled {
      cursor: default;
      opacity: 0.6;
      pointer-events: none;
    }

    .template-card.disabled:hover {
      transform: none;
      box-shadow: var(--shadow-sm);
      border-color: rgba(0,0,0,0.08);
    }
    
    .template-icon {
      font-size: 2.5rem;
      margin-bottom: var(--spacing-md);
      display: block;
    }
    
    .template-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0 0 8px 0;
    }
    
    .template-desc {
      color: var(--color-muted);
      font-size: 0.95rem;
      line-height: 1.4;
      margin: 0 0 15px 0;
    }
    
    .template-features {
      font-size: 0.85rem;
      color: var(--color-muted);
      opacity: 0.8;
    }

    .template-card-actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      margin-top: var(--spacing-md);
    }

    .template-card-actions .btn {
      flex: 1 1 48%;
      min-width: 120px;
      justify-content: center;
    }

    .template-summary {
      background: linear-gradient(180deg, rgba(37,99,235,0.12), rgba(30,64,175,0.1));
      border: 1px solid rgba(59,130,246,0.25);
      border-radius: calc(var(--radius) + 4px);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-sm);
      display: none;
    }

    .template-summary h2 {
      margin: 0;
      font-size: 1.6rem;
      color: #0f172a;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      gap: var(--spacing-lg);
      align-items: flex-start;
      margin-bottom: var(--spacing-md);
    }

    .summary-plan-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(37,99,235,0.15);
      color: var(--color-primary);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .summary-description {
      color: var(--color-muted);
      margin: 0;
    }

    .summary-features {
      list-style: none;
      margin: var(--spacing-md) 0 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }

    .summary-features li {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      background: rgba(148,163,184,0.12);
      padding: 10px 14px;
      border-radius: var(--radius);
      color: var(--color-text);
      font-size: 0.95rem;
    }

    .summary-features li span:first-child {
      color: var(--color-primary);
      font-weight: 600;
    }

    .summary-actions {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      margin-top: var(--spacing-md);
    }

    .summary-actions .btn {
      flex: 1 1 160px;
      justify-content: center;
    }

    .customize-section {
      background: var(--color-surface);
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: var(--radius);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-sm);
      margin-top: var(--spacing-xl);
    }

    .option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .option-grid label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .section-icon {
      font-size: 1.6rem;
    }

    .section-title {
      margin: 0;
      font-size: 1.25rem;
      color: var(--color-text);
    }

    .section-body {
      display: grid;
      gap: var(--spacing-md);
    }

    .media-button-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .service-card {
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      background: rgba(15,27,45,0.18);
    }

    .service-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .service-card-title {
      margin: 0;
      font-size: 1.05rem;
      color: white;
    }

    .remove-service-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s ease;
    }

    .remove-service-btn:hover {
      background: #dc2626;
    }

    .service-card .form-group {
      margin-bottom: 15px;
    }

    .service-card textarea {
      min-height: 80px;
    }

    .service-card .media-button-grid button {
      flex: 1 1 120px;
    }

    .service-card .service-image {
      margin-top: 10px;
    }

    .add-service-btn {
      width: 100%;
      justify-content: center;
    }
    
    .upload-zone {
      border: 3px dashed #334155;
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, rgba(249,115,22,0.02), rgba(234,88,12,0.02));
    }
    
    .upload-zone:hover {
      border-color: var(--color-primary);
      background: linear-gradient(135deg, rgba(249,115,22,0.05), rgba(234,88,12,0.05));
      transform: scale(1.02);
    }
    
    .upload-zone.dragover {
      border-color: var(--color-primary);
      background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(234,88,12,0.1));
      transform: scale(1.05);
    }
    
    .upload-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.7;
    }
    
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .preview-item {
      background: var(--color-card);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .preview-item:hover {
      border-color: var(--color-primary);
    }
    
    .preview-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .form-group {
      margin: 25px 0;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--color-text);
    }
    
    .form-input {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      background: var(--color-bg);
      border: 2px solid #334155;
      color: var(--color-text);
      font-size: 16px;
      transition: all 0.2s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn-primary-large {
      background: linear-gradient(135deg, var(--color-primary), #ea580c);
      color: white;
      border: none;
      padding: 18px 40px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
    }
    
    .btn-primary-large:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
    }
    
    .btn-secondary-large {
      background: transparent;
      color: var(--color-text);
      border: 2px solid #334155;
      padding: 18px 40px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-secondary-large:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 50px;
      padding-top: 30px;
      border-top: 1px solid rgba(148,163,184,0.1);
    }
    
    .step-content {
      min-height: 500px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .success-message {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.1));
      border-radius: 16px;
      border: 2px solid rgba(34,197,94,0.2);
    }
    
    .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    /* Customize Layout */
    .customize-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .customize-panel {
      width: 100%;
    }

    .preview-toggle {
      margin-bottom: 20px;
      text-align: center;
    }

    .preview-panel {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #334155;
      max-height: 80vh;
      overflow-y: auto;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #334155;
    }

    .preview-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      min-height: 400px;
    }

    /* Mobile Responsive */
    @media (min-width: 768px) {
      .customize-layout {
        grid-template-columns: 1fr 400px;
        gap: 20px;
      }
      
      .preview-panel {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
      }
    }

    @media (max-width: 767px) {
      .customize-layout {
        grid-template-columns: 1fr;
      }
      
      .preview-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        max-height: 100vh;
        border-radius: 0;
      }
      
      .preview-content {
        min-height: calc(100vh - 100px);
      }
    }

    /* Form Validation */
    .form-input.error {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 5px;
    }

    .form-group.required label::after {
      content: " *";
      color: #ef4444;
    }
    
    @media (max-width: 768px) {
      .setup-container {
        padding: 10px;
      }
      
      .upload-zone {
        padding: 40px 20px;
      }
      
      .step-title {
        font-size: 2rem;
      }

      .template-card-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Step 1: Choose Template -->
    <div id="step1" class="step-content">
      <div class="step-header">
        <h1 class="step-title">Choose Your Template</h1>
        <p class="step-subtitle">Browse tiers below. Starter sites publish instantly, Checkout enables payments, and Premium is on the way.</p>
      </div>
      
      <div class="template-grid" id="templateGrid"></div>
      
      <div class="navigation">
        <div></div>
        <p class="muted" id="autoAdvanceText" style="text-align: center; font-size: 0.9rem; opacity: 0;">Select any Starter or Checkout template to continue.</p>
      </div>
    </div>

    <!-- Step 2: Customize -->
    <div id="step2" class="step-content" style="display: none;">
      <div class="step-header">
        <h1 class="step-title">Customize Your Site</h1>
        <p class="step-subtitle">Edit all the details that matter</p>
      </div>
      
      <div class="customize-layout">
        <div class="customize-panel">
          <div class="template-summary" id="templateSummary" aria-live="polite"></div>
          <div class="preview-toggle">
            <button class="btn btn-secondary" id="previewToggle" onclick="togglePreview()">‚úï Close Preview</button>
          </div>
      
      <section class="customize-section" aria-labelledby="section-business">
        <div class="section-header">
          <span class="section-icon" aria-hidden="true">üè¢</span>
          <h3 id="section-business" class="section-title">Business Information</h3>
        </div>
        <div class="section-body">
          <div class="form-group">
            <label class="form-label">Business Name</label>
            <input type="text" class="form-input" id="businessName" placeholder="Enter your business name">
          </div>
          <div class="form-group">
            <label class="form-label">Tagline / Hero Title</label>
            <input type="text" class="form-input" id="heroTitle" placeholder="What makes you special?">
          </div>
          <div class="form-group">
            <label class="form-label">Subtitle / Description</label>
            <textarea class="form-input form-textarea" id="heroSubtitle" placeholder="Tell visitors what you do..."></textarea>
          </div>
        </div>
      </section>

      <section class="customize-section" aria-labelledby="section-cover">
        <div class="section-header">
          <span class="section-icon" aria-hidden="true">üì∏</span>
          <h3 id="section-cover" class="section-title">Cover Photo</h3>
        </div>
        <div class="section-body">
          <div class="form-group">
            <label class="form-label">Hero/Cover Image</label>
            <div class="media-button-grid">
              <button class="btn btn-secondary" onclick="pickHeroImage('camera')">üì∏ Camera</button>
              <button class="btn btn-secondary" onclick="pickHeroImage('gallery')">üñºÔ∏è Gallery</button>
              <button class="btn btn-secondary" onclick="pickHeroImage('url')">üîó URL</button>
            </div>
            <input type="file" id="heroImageFile" accept="image/*" capture="environment" style="display: none;">
            <input type="text" class="form-input" id="heroImage" placeholder="Or paste image URL here">
          </div>
        </div>
      </section>

      <section class="customize-section" aria-labelledby="section-services">
        <div class="section-header">
          <span class="section-icon" aria-hidden="true">‚öôÔ∏è</span>
          <h3 id="section-services" class="section-title">Services &amp; Products</h3>
        </div>
        <div class="section-body">
          <p class="muted">Add the offerings you want to highlight on your site. You can change or reorder them anytime.</p>
          <div id="servicesContainer"></div>
          <button class="btn btn-secondary add-service-btn" onclick="addService()">+ Add Service</button>
        </div>
      </section>

      <section class="customize-section" id="templateSpecificFields" aria-labelledby="section-template-fields" hidden>
        <div class="section-header">
          <span class="section-icon" aria-hidden="true">üéØ</span>
          <h3 id="section-template-fields" class="section-title">
            <span id="templateSpecificTitle">Template-Specific Fields</span>
          </h3>
        </div>
        <div class="section-body" id="templateSpecificContent">
          <!-- Dynamic content based on template -->
        </div>
      </section>

      <section class="customize-section" aria-labelledby="section-contact">
        <div class="section-header">
          <span class="section-icon" aria-hidden="true">üìû</span>
          <h3 id="section-contact" class="section-title">Contact Information</h3>
        </div>
        <div class="section-body">
          <div class="form-group required">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="contactEmail" placeholder="your@email.com" required>
            <div class="error-message" id="emailError"></div>
          </div>
          <div class="form-group required">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567" required>
            <div class="error-message" id="phoneError"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Address</label>
            <input type="text" class="form-input" id="contactAddress" placeholder="123 Main St, Your City">
          </div>
          <div class="form-group">
            <label class="form-label">Business Hours</label>
            <input type="text" class="form-input" id="businessHours" placeholder="Mon-Fri 9AM-5PM">
          </div>
        </div>
      </section>

      <section class="customize-section" aria-labelledby="section-social">
        <div class="section-header">
          <span class="section-icon" aria-hidden="true">üåê</span>
          <h3 id="section-social" class="section-title">Social Media &amp; Links</h3>
        </div>
        <div class="section-body">
          <div class="form-group">
            <label class="form-label">Website URL</label>
            <input type="url" class="form-input" id="websiteUrl" placeholder="https://yourwebsite.com">
          </div>
          <div class="form-group">
            <label class="form-label">Facebook</label>
            <input type="url" class="form-input" id="facebookUrl" placeholder="https://facebook.com/yourpage">
          </div>
          <div class="form-group">
            <label class="form-label">Instagram</label>
            <input type="url" class="form-input" id="instagramUrl" placeholder="https://instagram.com/yourpage">
          </div>
          <div class="form-group">
            <label class="form-label">Google Maps</label>
            <input type="url" class="form-input" id="googleMapsUrl" placeholder="https://maps.google.com/...">
          </div>
        </div>
      </section>
      
      </div>
      
      <div class="preview-panel" id="previewPanel">
        <div class="preview-header">
          <h3>Live Preview</h3>
          <button class="btn btn-secondary" onclick="togglePreview()">‚úï</button>
        </div>
        <div class="preview-content" id="previewContent">
          <!-- Live preview will be rendered here -->
        </div>
      </div>
    </div>
      
      <div class="navigation">
        <button class="btn-secondary-large" onclick="prevStep()">‚Üê Back</button>
        <button class="btn-primary-large" onclick="finishSetup()">‚úÖ Save Draft (Free)</button>
      </div>
    </div>

    <!-- Success Step -->
    <div id="success" class="step-content" style="display: none;">
      <div class="success-message">
        <div class="success-icon">üéâ</div>
        <h2>Your Site is Ready!</h2>
        <p class="muted">Redirecting you to customize and publish...</p>
      </div>
    </div>
  </div>

  <!-- Template Preview Modal -->
  <div id="templatePreviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; align-items: center; justify-content: center; padding: 20px;">
    <div style="background: white; border-radius: 16px; width: 100%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <h2 style="margin: 0; font-size: 1.5rem;" id="previewModalTitle">Template Preview</h2>
        <button onclick="closeTemplatePreview()" style="background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">‚úï</button>
      </div>
      <div style="flex: 1; overflow: hidden; background: #f8fafc;">
        <iframe id="previewIframe" style="width: 100%; height: 100%; border: none;" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
      <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="closeTemplatePreview()" class="btn btn-secondary">Close Preview</button>
        <button onclick="useTemplateFromPreview()" class="btn btn-primary" id="usePreviewTemplateBtn">Use This Template</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; font-size: 1.8rem;">Publish Your Site</h2>
        <button onclick="closePaymentModal()" style="background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">‚úï</button>
      </div>
      
      <p style="color: #64748b; margin-bottom: 25px;">Choose a plan to make your site live and accessible to the world.</p>
      
      <div id="planSelection" style="margin-bottom: 25px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
          <label style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;">
            <input type="radio" name="plan" value="starter" checked style="margin-right: 10px;">
            <div>
              <strong>Starter</strong>
              <div style="font-size: 1.5rem; color: #f97316; margin: 5px 0;">$9<span style="font-size: 0.9rem;">/mo</span></div>
            </div>
          </label>
          <label style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;">
            <input type="radio" name="plan" value="business" style="margin-right: 10px;">
            <div>
              <strong>Business</strong>
              <div style="font-size: 1.5rem; color: #f97316; margin: 5px 0;">$19<span style="font-size: 0.9rem;">/mo</span></div>
            </div>
          </label>
          <label style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;">
            <input type="radio" name="plan" value="pro" style="margin-right: 10px;">
            <div>
              <strong>Pro</strong>
              <div style="font-size: 1.5rem; color: #f97316; margin: 5px 0;">$39<span style="font-size: 0.9rem;">/mo</span></div>
            </div>
          </label>
        </div>
      </div>
      
      <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
        <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">What You'll Get:</h3>
        <div id="planFeatures">
          <div style="margin: 8px 0; display: flex; align-items: center;">
            <span style="margin-right: 10px;">‚úì</span>
            <span>Your site goes live with a unique URL</span>
          </div>
          <div style="margin: 8px 0; display: flex; align-items: center;">
            <span style="margin-right: 10px;">‚úì</span>
            <span>Mobile-responsive design</span>
          </div>
          <div style="margin: 8px 0; display: flex; align-items: center;">
            <span style="margin-right: 10px;">‚úì</span>
            <span>Unlimited updates</span>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">üìß Email Address <span style="color: #ef4444;">*</span></label>
        <input type="email" id="paymentEmail" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" placeholder="your@email.com" required>
        
        <!-- Important Notice -->
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin-top: 15px; border-radius: 8px;">
          <p style="margin: 0; font-size: 0.9rem; color: #92400e; line-height: 1.6;">
            <strong>‚ö†Ô∏è Required:</strong> Your email is used to send you:<br>
            ‚Ä¢ Your site's login credentials<br>
            ‚Ä¢ The website URL<br>
            ‚Ä¢ Important information about your account<br>
            <span style="display: block; margin-top: 8px; font-size: 0.85rem;">üí° You can change these credentials anytime after publishing.</span>
          </p>
        </div>
      </div>
      
      <button onclick="processPayment()" class="btn btn-primary-large" style="width: 100%;">
        üí≥ Pay & Publish
      </button>
      
      <p style="text-align: center; font-size: 0.85rem; color: #64748b; margin-top: 15px;">
        Secure payment by Stripe. Cancel anytime.
      </p>
    </div>
  </div>

  <script>
    let currentStep = 2; // Start at customization step
    let selectedTemplate = null;
    let uploadedImages = [];
    let ADMIN_TOKEN = null;

    // Fetch admin token from server
    async function getAdminToken() {
      if (ADMIN_TOKEN) return ADMIN_TOKEN;
      try {
        const response = await fetch('/api/admin-token');
        const data = await response.json();
        ADMIN_TOKEN = data.token;
        return ADMIN_TOKEN;
      } catch (error) {
        console.error('Failed to get admin token:', error);
        return null;
      }
    }

    // Load site data into form fields for editing
    async function loadSiteDataIntoForm(site) {
      try {
        // Basic business info
        if (document.getElementById('businessName')) {
          document.getElementById('businessName').value = site.brand?.name || '';
        }
        if (document.getElementById('heroTitle')) {
          document.getElementById('heroTitle').value = site.hero?.title || '';
        }
        if (document.getElementById('heroSubtitle')) {
          document.getElementById('heroSubtitle').value = site.hero?.subtitle || '';
        }
        if (document.getElementById('heroImage')) {
          document.getElementById('heroImage').value = site.hero?.image || '';
        }
        
        // Contact info
        if (document.getElementById('email')) {
          document.getElementById('email').value = site.contact?.email || '';
        }
        if (document.getElementById('phone')) {
          document.getElementById('phone').value = site.contact?.phone || '';
        }
        if (document.getElementById('address')) {
          document.getElementById('address').value = site.contact?.address || '';
        }
        if (document.getElementById('hours')) {
          document.getElementById('hours').value = site.contact?.hours || '';
        }
        
        // Social links
        if (document.getElementById('website')) {
          document.getElementById('website').value = site.social?.website || '';
        }
        if (document.getElementById('facebook')) {
          document.getElementById('facebook').value = site.social?.facebook || '';
        }
        if (document.getElementById('instagram')) {
          document.getElementById('instagram').value = site.social?.instagram || '';
        }
        if (document.getElementById('maps')) {
          document.getElementById('maps').value = site.social?.maps || '';
        }
        
        // Services/Products
        const servicesList = document.getElementById('servicesList');
        if (servicesList && site.services) {
          servicesList.innerHTML = ''; // Clear existing
          const servicesArray = site.services.items || site.services || [];
          servicesArray.forEach((service, index) => {
            addServiceField(
              service.title || service.name || '',
              service.description || '',
              service.price || '',
              service.image || ''
            );
          });
        }
        
        // For product-based templates
        if (site.products && Array.isArray(site.products)) {
          site.products.forEach((product, index) => {
            const nameInput = document.getElementById(`product${index}Name`);
            const priceInput = document.getElementById(`product${index}Price`);
            const descInput = document.getElementById(`product${index}Description`);
            const imageInput = document.getElementById(`product${index}Image`);
            
            if (nameInput) nameInput.value = product.name || '';
            if (priceInput) priceInput.value = product.price || '';
            if (descInput) descInput.value = product.description || '';
            if (imageInput) imageInput.value = product.image || '';
          });
        }
        
        // Template-specific fields
        if (site.custom) {
          Object.keys(site.custom).forEach(key => {
            const field = document.getElementById(key);
            if (field) {
              if (field.type === 'checkbox') {
                field.checked = site.custom[key];
              } else {
                field.value = site.custom[key];
              }
            }
          });
        }
        
        // Trigger preview update
        updatePreview();
        
        console.log('Site data loaded into form successfully');
      } catch (error) {
        console.error('Error loading site data into form:', error);
      }
    }

    // Initialize - load template from URL parameter or edit mode
    window.addEventListener('DOMContentLoaded', async () => {
      renderTemplateSummary(null);
      const params = new URLSearchParams(window.location.search);
      const templateId = params.get('template');
      const editSubdomain = params.get('edit');
      
      // Check if we're in edit mode
      if (editSubdomain) {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            alert('Please log in to edit your site');
            window.location.href = '/login.html';
            return;
          }
          
          // Fetch the published site data
          const response = await fetch(`/api/sites/${editSubdomain}`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            const error = await response.json();
            alert(`Failed to load site: ${error.error}`);
            window.location.href = '/dashboard.html';
            return;
          }
          
          const { site, subdomain } = await response.json();
          
          // Load the template for this site
          const templatesResponse = await fetch('/data/templates/index.json');
          const templatesData = await templatesResponse.json();
          const template = templatesData.templates.find(t => t.id === site.templateId);
          
          if (!template) {
            alert('Template not found for this site');
            window.location.href = '/dashboard.html';
            return;
          }
          
          selectedTemplate = template;
          renderTemplateSummary(template);
          
          // Hide step 1, show step 2
          document.getElementById('step1').style.display = 'none';
          document.getElementById('step2').style.display = 'block';
          document.querySelector('.progress-bar').style.display = 'none';
          
          // Setup customization
          await setupCustomize();
          
          // Pre-populate form with existing site data
          await loadSiteDataIntoForm(site);
          
          // Mark as edit mode
          const publishBtn = document.querySelector('.publish-btn');
          if (publishBtn) {
            publishBtn.textContent = 'üìù Update Site';
            publishBtn.dataset.editMode = 'true';
            publishBtn.dataset.subdomain = subdomain;
          }
          
          // Show edit notification
          const notification = document.createElement('div');
          notification.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-weight: 600;';
          notification.textContent = '‚úèÔ∏è Editing Mode: Make changes and click "Update Site" to save';
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 5000);
          
          // Show preview
          const panel = document.getElementById('previewPanel');
          const toggle = document.getElementById('previewToggle');
          if (panel && toggle) {
            panel.style.display = 'block';
            toggle.textContent = '‚úï Close Preview';
          }
          updatePreview();
          
        } catch (error) {
          console.error('Failed to load site for editing:', error);
          alert('Failed to load site. Please try again.');
          window.location.href = '/dashboard.html';
        }
      } else if (templateId) {
        // Load template from URL
        try {
          const response = await fetch('/data/templates/index.json');
          const data = await response.json();
          const template = data.templates.find(t => t.id === templateId);
          
          if (template) {
            selectedTemplate = template;
            renderTemplateSummary(template);
            // Hide step 1 (template selection), show step 2 (customization)
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            
            // Hide progress bar since we're skipping step 1
            document.querySelector('.progress-bar').style.display = 'none';
            
            // Setup customization
            await setupCustomize();
            
            // Show preview panel automatically
            const panel = document.getElementById('previewPanel');
            const toggle = document.getElementById('previewToggle');
            if (panel && toggle) {
              panel.style.display = 'block';
              toggle.textContent = '‚úï Close Preview';
            }
            updatePreview();
          }
        } catch (error) {
          console.error('Failed to load template:', error);
        }
      } else {
        // No template selected, show step 1
        currentStep = 1;
        loadTemplates();
      }
      
      setupDragAndDrop();
      
      // Add keyboard support for modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const previewModal = document.getElementById('templatePreviewModal');
          if (previewModal && previewModal.style.display === 'flex') {
            closeTemplatePreview();
          }
        }
      });
    });

    const PLAN_METADATA = {
      Starter: {
        title: 'üéØ Starter Templates (Display Only)',
        description: 'Perfect for service businesses. Show pricing, hours, and contact info with offline CTAs (call, email, visit, external booking). No payment processing included.',
        badge: 'View-Only',
        empty: 'Starter templates will appear here.'
      },
      Checkout: {
        title: 'üí≥ Checkout Templates (Payment Enabled)',
        description: 'Everything in Starter, plus Stripe checkout integration. Accept payments online, send automated order confirmations, and manage orders from the admin dashboard.',
        badge: 'Payment Processing',
        empty: 'Checkout templates will appear here soon.'
      },
      Premium: {
        title: 'üöÄ Premium Suite (Coming Soon)',
        description: 'Everything in Checkout, plus multi-page layouts, blog, scheduling integrations, CRM automation, and advanced analytics. Currently in development.',
        badge: 'Full-Site',
        comingSoonMessage: 'Premium Suite is in development. Join the waitlist to get early access and influence the roadmap.'
      }
    };

    function resolveTemplateFeatures(template) {
      if (!template) return [];
      if (Array.isArray(template.features) && template.features.length) {
        return template.features;
      }
      if (template.plan === 'Checkout') {
        return [
          'Stripe Checkout built-in',
          'Idempotent payment requests',
          'Order metadata captured automatically'
        ];
      }
      return [
        'Responsive sections for hero, services, and testimonials',
        'Simple content editing from the dashboard',
        'SEO-friendly structure with sharing metadata'
      ];
    }

    function renderTemplateSummary(template) {
      const summary = document.getElementById('templateSummary');
      if (!summary) return;

      if (!template) {
        summary.style.display = 'none';
        summary.innerHTML = '';
        return;
      }

      const planLabel = template.plan === 'Checkout'
        ? 'Checkout Ready'
        : template.plan === 'Premium'
          ? 'Premium Suite'
          : 'Starter Catalog';

      const description = template.description || 'Customize this template to match your brand.';
      const features = resolveTemplateFeatures(template);

      summary.style.display = 'block';
      summary.innerHTML = `
        <div class="summary-header">
          <div>
            <span class="summary-plan-pill">${planLabel}</span>
            <h2>${template.name}</h2>
            <p class="summary-description">${description}</p>
          </div>
        </div>
        <div class="summary-actions">
          <button type="button" class="btn btn-secondary" onclick="returnToTemplateSelection()">Change template</button>
          <button type="button" class="btn btn-primary" onclick="ensurePreviewVisible()">View Live Preview</button>
        </div>
        <ul class="summary-features">
          ${features.map(feature => `<li><span aria-hidden="true">‚úî</span><span>${feature}</span></li>`).join('')}
        </ul>
      `;
    }

    let previewingTemplate = null;

    function openTemplatePreview(template) {
      previewingTemplate = template;
      const modal = document.getElementById('templatePreviewModal');
      const iframe = document.getElementById('previewIframe');
      const title = document.getElementById('previewModalTitle');
      
      if (modal && iframe && title) {
        title.textContent = `Preview: ${template.name}`;
        // Use preview.html which includes app.js to render templates dynamically
        const previewUrl = `/preview.html?template=${encodeURIComponent(template.id)}`;
        iframe.src = previewUrl;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function closeTemplatePreview() {
      const modal = document.getElementById('templatePreviewModal');
      const iframe = document.getElementById('previewIframe');
      
      if (modal && iframe) {
        modal.style.display = 'none';
        iframe.src = '';
        document.body.style.overflow = '';
      }
      previewingTemplate = null;
    }

    function useTemplateFromPreview() {
      if (previewingTemplate) {
        closeTemplatePreview();
        // Find the template card and select it
        const cards = document.querySelectorAll('.template-card');
        cards.forEach(card => {
          const name = card.querySelector('.template-name');
          if (name && name.textContent === previewingTemplate.name) {
            selectTemplate(previewingTemplate, card);
          }
        });
      }
    }

    function returnToTemplateSelection() {
      selectedTemplate = null;
      currentStep = 1;
      renderTemplateSummary(null);
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      if (step1 && step2) {
        step1.style.display = 'block';
        step2.style.display = 'none';
      }
      const progressBar = document.querySelector('.progress-bar');
      if (progressBar) progressBar.style.display = '';
      updateProgress();
      loadTemplates();
    }

    async function loadTemplates() {
      try {
        const response = await fetch('/data/templates/index.json');
        const data = await response.json();

        renderTemplateSummary(null);
        const grid = document.getElementById('templateGrid');
        const guide = document.getElementById('autoAdvanceText');
        if (!grid) return;
        grid.innerHTML = '';
        if (guide) {
          guide.textContent = 'Select any template to continue. Premium templates include advanced features!';
          guide.style.opacity = 1;
        }

        ['Starter', 'Checkout', 'Premium'].forEach(plan => {
          const meta = PLAN_METADATA[plan];
          if (!meta) return;

          const tierSection = document.createElement('section');
          tierSection.className = 'template-tier-card';

          const header = document.createElement('div');
          header.className = 'template-tier-header';
          header.innerHTML = `<h3>${meta.title}</h3><p>${meta.description}</p>`;
          tierSection.appendChild(header);

          const templatesForPlan = data.templates.filter(t => t.plan === plan);

          if (plan === 'Premium') {
            if (templatesForPlan.length) {
              const cardGrid = document.createElement('div');
              cardGrid.className = 'template-card-grid';
              templatesForPlan.forEach(template => {
                cardGrid.appendChild(createTemplateCard(template, {
                  disabled: true,
                  disabledMessage: meta.comingSoonMessage
                }));
              });
              tierSection.appendChild(cardGrid);
            } else {
              const message = document.createElement('p');
              message.className = 'muted';
              message.style.marginTop = 'var(--spacing-md)';
              message.textContent = meta.comingSoonMessage;
              tierSection.appendChild(message);
            }
          } else {
            if (templatesForPlan.length) {
              const cardGrid = document.createElement('div');
              cardGrid.className = 'template-card-grid';
              templatesForPlan.forEach(template => {
                cardGrid.appendChild(createTemplateCard(template));
              });
              tierSection.appendChild(cardGrid);
            } else {
              const emptyState = document.createElement('p');
              emptyState.className = 'muted';
              emptyState.style.marginTop = 'var(--spacing-md)';
              emptyState.textContent = meta.empty;
              tierSection.appendChild(emptyState);
            }
          }

          grid.appendChild(tierSection);
        });
      } catch (error) {
        console.error('Failed to load templates:', error);
      }
    }

    function getTemplateIcon(id) {
      const icons = {
        'restaurant': 'üçΩÔ∏è',
        'salon': 'üíá‚Äç‚ôÄÔ∏è',
        'gym': 'üí™',
        'consultant': 'üíº',
        'tech-repair': 'üîß',
        'cleaning': 'üßΩ',
        'pet-care': 'üêï',
        'freelancer': 'üé®',
        'starter': 'üöÄ',
        'product-showcase': 'üõçÔ∏è',
        'product-ordering': 'üõí'
      };
      return icons[id] || 'üìã';
    }

    function createTemplateCard(template, options = {}) {
      const card = document.createElement('div');
      card.className = 'template-card';
      card.style.setProperty('--template-color', template.color || 'var(--color-primary)');

      const isDisabled = Boolean(options.disabled || template.plan === 'Premium' || template.status === 'coming-soon');
      if (isDisabled) {
        card.classList.add('disabled');
      }

      const badge = document.createElement('span');
      badge.className = 'template-plan-badge';
      badge.textContent = template.plan === 'Checkout' ? 'Checkout tier' : template.plan === 'Premium' ? 'Premium tier' : 'Starter tier';
      card.appendChild(badge);

      const icon = document.createElement('div');
      icon.className = 'template-icon';
      icon.textContent = getTemplateIcon(template.id);
      card.appendChild(icon);

      const name = document.createElement('h3');
      name.className = 'template-name';
      name.textContent = template.name;
      card.appendChild(name);

      if (template.description) {
        const desc = document.createElement('p');
        desc.className = 'template-desc';
        desc.textContent = template.description;
        card.appendChild(desc);
      }

      const features = resolveTemplateFeatures(template);

      if (features.length) {
        const list = document.createElement('ul');
        list.className = 'feature-list';
        features.forEach(feature => {
          const li = document.createElement('li');
          li.textContent = feature;
          list.appendChild(li);
        });
        card.appendChild(list);
      }

      if (isDisabled) {
        const message = document.createElement('p');
        message.className = 'muted';
        message.style.marginTop = 'var(--spacing-md)';
        message.textContent = options.disabledMessage || 'Coming soon.';
        card.appendChild(message);
      } else {
        const actions = document.createElement('div');
        actions.className = 'template-card-actions';

        const selectBtn = document.createElement('button');
        selectBtn.type = 'button';
        selectBtn.className = 'btn btn-primary';
        selectBtn.textContent = 'Use Template';
        selectBtn.onclick = (event) => {
          event.stopPropagation();
          selectTemplate(template, card);
        };

        const preview = document.createElement('button');
        preview.type = 'button';
        preview.className = 'btn btn-secondary';
        preview.textContent = 'Quick Preview';
        preview.title = 'Preview template in modal';
        preview.onclick = (event) => {
          event.stopPropagation();
          openTemplatePreview(template);
        };

        actions.appendChild(selectBtn);
        actions.appendChild(preview);
        card.appendChild(actions);

        card.addEventListener('click', () => selectTemplate(template, card));
      }

      return card;
    }

    function selectTemplate(template, element) {
      // Premium templates are now available!
      selectedTemplate = template;
      renderTemplateSummary(template);
      const guide = document.getElementById('autoAdvanceText');
      if (guide) guide.style.opacity = 0;
      
      // Update UI
      document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
      element.classList.add('selected');
      
      // Auto-advance to customization step after 1 second
      setTimeout(() => {
        currentStep = 2;
        updateProgress();
        setupCustomize();
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) progressBar.style.display = 'none';
        
        // Show preview by default when entering step 2
        setTimeout(() => {
          const panel = document.getElementById('previewPanel');
          const toggle = document.getElementById('previewToggle');
          if (panel && toggle) {
            panel.style.display = 'block';
            toggle.textContent = '‚úï Close Preview';
          }
          updatePreview();
        }, 100);
      }, 1000);
    }

    function nextStep() {
      if (currentStep === 1 && !selectedTemplate) {
        alert('Please select a template first');
        return;
      }
      
      // Hide current step
      document.getElementById(`step${currentStep}`).style.display = 'none';
      
      // Show next step
      currentStep++;
      document.getElementById(`step${currentStep}`).style.display = 'block';
      
      // Update progress
      updateProgress();
      
      // Setup step-specific functionality
      if (currentStep === 2) {
        setupImageUpload();
      } else if (currentStep === 3) {
        setupCustomize();
      }
    }

    function prevStep() {
      // Hide current step
      document.getElementById(`step${currentStep}`).style.display = 'none';
      
      // Show previous step
      currentStep--;
      document.getElementById(`step${currentStep}`).style.display = 'block';
      
      // Update progress
      updateProgress();

       if (currentStep === 1) {
         const progressBar = document.querySelector('.progress-bar');
         if (progressBar) progressBar.style.display = '';
         renderTemplateSummary(null);
         loadTemplates();
       }
    }

    function updateProgress() {
      const progress = (currentStep / 2) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;
    }

    function setupImageUpload() {
      // Already handled by drag and drop setup
    }

    function setupDragAndDrop() {
      const uploadZone = document.getElementById('uploadZone');
      
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });
      
      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });
      
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
    }

    function handleFileUpload(event) {
      handleFiles(event.target.files);
    }

    function handleFiles(files) {
      const preview = document.getElementById('imagePreview');
      
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedImages.push({
              file: file,
              url: e.target.result,
              name: file.name
            });
            
            updateImagePreview();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function updateImagePreview() {
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      uploadedImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `
          <img src="${img.url}" class="preview-image" alt="${img.name}">
          <p style="font-size: 0.85rem; color: var(--color-muted); margin: 5px 0;">${img.name}</p>
          <button onclick="removeImage(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">Remove</button>
        `;
        preview.appendChild(item);
      });
    }

    function removeImage(index) {
      uploadedImages.splice(index, 1);
      updateImagePreview();
    }

    async function setupCustomize() {
      if (!selectedTemplate) return;
      
      // Load template data
      try {
        const response = await fetch(`/data/templates/${selectedTemplate.id}.json`);
        const templateData = await response.json();
        
        // Populate basic info
        document.getElementById('businessName').value = templateData.brand?.name || '';
        document.getElementById('heroTitle').value = templateData.hero?.title || '';
        document.getElementById('heroSubtitle').value = templateData.hero?.subtitle || '';
        document.getElementById('heroImage').value = templateData.hero?.image || '';
        document.getElementById('contactEmail').value = templateData.contact?.email || '';
        document.getElementById('contactPhone').value = templateData.contact?.phone || '';
        document.getElementById('contactAddress').value = templateData.contact?.subtitle || '';
        
        // Populate services/products
        populateServices(templateData);
        
        // Populate template-specific fields
        populateTemplateSpecificFields(templateData);
        
        // Add real-time preview listeners
        addPreviewListeners();
        
        // Add validation listeners
        addValidationListeners();
      } catch (error) {
        console.error('Failed to load template data:', error);
      }
    }

    function populateTemplateSpecificFields(templateData) {
      const titleEl = document.getElementById('templateSpecificTitle');
      const contentEl = document.getElementById('templateSpecificContent');
      const sectionEl = document.getElementById('templateSpecificFields');
      if (!titleEl || !contentEl || !sectionEl) return;
      contentEl.innerHTML = '';
      sectionEl.hidden = true;
      
      switch(selectedTemplate.id) {
        case 'restaurant':
          titleEl.textContent = 'Restaurant Details';
          contentEl.innerHTML = `
            <div class="form-group">
              <label class="form-label">Cuisine Type</label>
              <select class="form-input" id="cuisineType">
                <option value="">Select cuisine type</option>
                <option value="italian">Italian</option>
                <option value="mexican">Mexican</option>
                <option value="asian">Asian</option>
                <option value="american">American</option>
                <option value="mediterranean">Mediterranean</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Average Price Range</label>
              <select class="form-input" id="priceRange">
                <option value="">Select price range</option>
                <option value="$">$ (Budget-friendly)</option>
                <option value="$$">$$ (Moderate)</option>
                <option value="$$$">$$$ (Upscale)</option>
                <option value="$$$$">$$$$ (Fine dining)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Special Features</label>
              <div class="option-grid">
                <label><input type="checkbox" id="delivery"> Delivery</label>
                <label><input type="checkbox" id="takeout"> Takeout</label>
                <label><input type="checkbox" id="reservations"> Reservations</label>
                <label><input type="checkbox" id="outdoor"> Outdoor Seating</label>
                <label><input type="checkbox" id="bar"> Full Bar</label>
                <label><input type="checkbox" id="kids"> Kid-Friendly</label>
              </div>
            </div>
          `;
          sectionEl.hidden = false;
          break;
          
        case 'salon':
          titleEl.textContent = 'Salon Details';
          contentEl.innerHTML = `
            <div class="form-group">
              <label class="form-label">Services Offered</label>
              <div class="option-grid">
                <label><input type="checkbox" id="haircuts"> Haircuts</label>
                <label><input type="checkbox" id="coloring"> Hair Coloring</label>
                <label><input type="checkbox" id="styling"> Hair Styling</label>
                <label><input type="checkbox" id="manicures"> Manicures</label>
                <label><input type="checkbox" id="pedicures"> Pedicures</label>
                <label><input type="checkbox" id="facials"> Facials</label>
                <label><input type="checkbox" id="massage"> Massage</label>
                <label><input type="checkbox" id="eyebrows"> Eyebrows</label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Appointment Booking</label>
              <select class="form-input" id="bookingType">
                <option value="">Select booking method</option>
                <option value="phone">Phone Only</option>
                <option value="online">Online Booking</option>
                <option value="walkin">Walk-ins Welcome</option>
                <option value="both">Phone + Online</option>
              </select>
            </div>
          `;
          sectionEl.hidden = false;
          break;
          
        case 'gym':
          titleEl.textContent = 'Gym Details';
          contentEl.innerHTML = `
            <div class="form-group">
              <label class="form-label">Facility Features</label>
              <div class="option-grid">
                <label><input type="checkbox" id="cardio"> Cardio Equipment</label>
                <label><input type="checkbox" id="weights"> Free Weights</label>
                <label><input type="checkbox" id="machines"> Weight Machines</label>
                <label><input type="checkbox" id="classes"> Group Classes</label>
                <label><input type="checkbox" id="pool"> Swimming Pool</label>
                <label><input type="checkbox" id="sauna"> Sauna</label>
                <label><input type="checkbox" id="trainer"> Personal Training</label>
                <label><input type="checkbox" id="parking"> Free Parking</label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Membership Types</label>
              <div class="option-grid">
                <label><input type="checkbox" id="monthly"> Monthly</label>
                <label><input type="checkbox" id="yearly"> Yearly</label>
                <label><input type="checkbox" id="daypass"> Day Pass</label>
                <label><input type="checkbox" id="student"> Student Discount</label>
                <label><input type="checkbox" id="senior"> Senior Discount</label>
                <label><input type="checkbox" id="family"> Family Plans</label>
              </div>
            </div>
          `;
          sectionEl.hidden = false;
          break;
          
        default:
          titleEl.textContent = 'Additional Information';
          contentEl.innerHTML = `
            <div class="form-group">
              <label class="form-label">Business Description</label>
              <textarea class="form-input form-textarea" id="businessDescription" placeholder="Tell us more about your business..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Special Offers</label>
              <input type="text" class="form-input" id="specialOffers" placeholder="Any current promotions or offers?">
            </div>
          `;
          sectionEl.hidden = false;
      }
    }

    function addPreviewListeners() {
      const inputs = document.querySelectorAll('#step2 input, #step2 textarea, #step2 select');
      inputs.forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
      });
    }

    function updatePreview() {
      const previewContent = document.getElementById('previewContent');
      
      if (!previewContent) {
        return;
      }
      
      const businessName = document.getElementById('businessName').value || 'Your Business';
      const heroTitle = document.getElementById('heroTitle').value || 'Welcome to Our Business';
      const heroSubtitle = document.getElementById('heroSubtitle').value || 'We provide excellent service';
      const heroImage = document.getElementById('heroImage').value || '/uploads/default-hero.jpg';
      
      previewContent.innerHTML = `
        <!-- Social Share Preview -->
        <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; font-size: 0.875rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Share Preview</h4>
          <div style="border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; background: white;">
            ${heroImage && heroImage.startsWith('http') ? `<img src="${heroImage}" style="width: 100%; height: 200px; object-fit: cover; display: block;" />` : ''}
            <div style="padding: 12px;">
              <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">${new URL(window.location.origin).hostname}</div>
              <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem; margin-bottom: 2px;">${businessName}</div>
              <div style="color: #64748b; font-size: 0.8rem;">${heroSubtitle}</div>
            </div>
          </div>
        </div>
        
        <div style="font-family: system-ui, -apple-system, sans-serif; color: #1f2937;">
          <div style="background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 40px 20px; text-align: center; border-radius: 8px; margin-bottom: 20px;">
            <h1 style="margin: 0 0 10px 0; font-size: 2rem;">${businessName}</h1>
            <h2 style="margin: 0 0 15px 0; font-size: 1.25rem; opacity: 0.9;">${heroTitle}</h2>
            <p style="margin: 0; opacity: 0.8;">${heroSubtitle}</p>
          </div>
          
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #1f2937;">Services</h3>
            <div id="previewServices"></div>
          </div>
          
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
            <h3 style="margin: 0 0 15px 0; color: #1f2937;">Contact</h3>
            <p style="margin: 5px 0;"><strong>Email:</strong> ${document.getElementById('contactEmail').value || 'your@email.com'}</p>
            <p style="margin: 5px 0;"><strong>Phone:</strong> ${document.getElementById('contactPhone').value || '(555) 123-4567'}</p>
            <p style="margin: 5px 0;"><strong>Address:</strong> ${document.getElementById('contactAddress').value || '123 Main St'}</p>
          </div>
        </div>
      `;
      
      // Update services preview
      updateServicesPreview();
    }

    function updateServicesPreview() {
      const previewServices = document.getElementById('previewServices');
      if (!previewServices) return;
      
      const serviceFields = document.querySelectorAll('#servicesContainer > .service-card');
      let servicesHtml = '';
      
      serviceFields.forEach(field => {
        const name = field.querySelector('.service-name')?.value;
        const description = field.querySelector('.service-description')?.value;
        const price = field.querySelector('.service-price')?.value;
        
        if (name) {
          servicesHtml += `
            <div style="border-bottom: 1px solid #e5e7eb; padding: 10px 0;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #1f2937;">${name}</h4>
                ${price ? `<span style="color: #f97316; font-weight: bold;">${price}</span>` : ''}
              </div>
              ${description ? `<p style="margin: 5px 0 0 0; color: #6b7280; font-size: 0.9rem;">${description}</p>` : ''}
            </div>
          `;
        }
      });
      
      previewServices.innerHTML = servicesHtml || '<p style="color: #9ca3af;">No services added yet</p>';
    }

    function addValidationListeners() {
      const emailInput = document.getElementById('contactEmail');
      const phoneInput = document.getElementById('contactPhone');
      
      emailInput.addEventListener('blur', validateEmail);
      phoneInput.addEventListener('blur', validatePhone);
    }

    function validateEmail() {
      const email = document.getElementById('contactEmail').value;
      const errorEl = document.getElementById('emailError');
      const inputEl = document.getElementById('contactEmail');
      
      if (!email) {
        showError(inputEl, errorEl, 'Email is required');
        return false;
      }
      
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError(inputEl, errorEl, 'Please enter a valid email address');
        return false;
      }
      
      clearError(inputEl, errorEl);
      return true;
    }

    function validatePhone() {
      const phone = document.getElementById('contactPhone').value;
      const errorEl = document.getElementById('phoneError');
      const inputEl = document.getElementById('contactPhone');
      
      if (!phone) {
        showError(inputEl, errorEl, 'Phone number is required');
        return false;
      }
      
      const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
      if (!phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''))) {
        showError(inputEl, errorEl, 'Please enter a valid phone number');
        return false;
      }
      
      clearError(inputEl, errorEl);
      return true;
    }

    function showError(inputEl, errorEl, message) {
      inputEl.classList.add('error');
      errorEl.textContent = message;
    }

    function clearError(inputEl, errorEl) {
      inputEl.classList.remove('error');
      errorEl.textContent = '';
    }

    function ensurePreviewVisible() {
      const panel = document.getElementById('previewPanel');
      const toggle = document.getElementById('previewToggle');
      
      if (!panel || !toggle) {
        console.error('Preview elements not found');
        return;
      }
      
      // Always show the preview and update content
      updatePreview();
      panel.style.display = 'block';
      toggle.textContent = '‚úï Close Preview';
      
      // On mobile, scroll to preview
      if (window.innerWidth < 768) {
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function togglePreview() {
      const panel = document.getElementById('previewPanel');
      const toggle = document.getElementById('previewToggle');
      
      if (!panel || !toggle) {
        console.error('Preview elements not found');
        return;
      }
      
      // Ensure preview content is populated before showing
      updatePreview();
      
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        toggle.textContent = '‚úï Close Preview';
      } else {
        panel.style.display = 'none';
        toggle.textContent = 'üëÅÔ∏è Live Preview';
      }
    }

    function populateServices(templateData) {
      const container = document.getElementById('servicesContainer');
      container.innerHTML = '';
      
      // Get services from template (could be 'services' or 'products')
      const services = templateData.services?.items || templateData.products || [];
      
      services.forEach((service, index) => {
        container.appendChild(createServiceField(service, index));
      });
      
      if (services.length === 0) {
        // Add empty service if none exist
        container.appendChild(createServiceField({name: '', description: '', price: '', image: ''}, 0));
      }

      refreshServiceNumbers();
    }

    function createServiceField(service, index) {
      const div = document.createElement('div');
      div.className = 'service-card';
      div.innerHTML = `
        <div class="service-card-header">
          <h4 class="service-card-title">Service ${index + 1}</h4>
          <button type="button" class="remove-service-btn" onclick="removeService(this)">Remove</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">Service Name</label>
          <input type="text" class="form-input service-name" placeholder="e.g., Haircut, Pizza, Training" value="${service.name || service.title || ''}">
        </div>
        
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input form-textarea service-description" placeholder="Describe this service...">${service.description || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Price (optional)</label>
          <input type="text" class="form-input service-price" placeholder="$0" value="${service.price || ''}">
        </div>
        
        <div class="form-group">
          <label class="form-label">Service Image</label>
          <div class="media-button-grid">
            <button type="button" class="btn btn-secondary" onclick="openImagePicker(this, 'camera')">üì∏ Camera</button>
            <button type="button" class="btn btn-secondary" onclick="openImagePicker(this, 'gallery')">üñºÔ∏è Gallery</button>
            <button type="button" class="btn btn-secondary" onclick="openImagePicker(this, 'url')">üîó URL</button>
          </div>
          <input type="file" class="service-image-file" accept="image/*" capture="environment" style="display: none;">
          <input type="text" class="form-input service-image" placeholder="Or paste image URL here" value="${service.image || ''}">
        </div>
      `;
      
      return div;
    }

    function refreshServiceNumbers() {
      const titles = document.querySelectorAll('#servicesContainer .service-card-title');
      titles.forEach((title, idx) => {
        title.textContent = `Service ${idx + 1}`;
      });
    }

    async function openImagePicker(element, type) {
      const card = element.closest('.service-card');
      const fileInput = card.querySelector('.service-image-file');
      const imageInput = card.querySelector('.service-image');
      
      if (type === 'camera' || type === 'gallery') {
        fileInput.setAttribute('capture', type === 'camera' ? 'environment' : 'user');
        fileInput.click();
        fileInput.onchange = async (e) => {
          const file = e.target.files[0];
          if (file) {
            // Show uploading status
            imageInput.value = `[Uploading ${file.name}...]`;
            imageInput.style.color = '#94a3b8';
            
            try {
              // Upload to server
              const formData = new FormData();
              formData.append('image', file);
              
              const token = await getAdminToken();
              const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                body: formData
              });
              
              if (!response.ok) {
                throw new Error('Upload failed');
              }
              
              const result = await response.json();
              
              // Update image input with server URL
              imageInput.value = result.url;
              imageInput.style.color = '#1f2937';
              
              // Trigger preview update
              updatePreview();
              
            } catch (error) {
              console.error('Upload error:', error);
              imageInput.value = '';
              imageInput.style.color = '#ef4444';
              alert('Failed to upload image. Please try again or use a URL.');
            }
          }
        };
      } else if (type === 'url') {
        imageInput.focus();
      }
    }

    function addService() {
      const container = document.getElementById('servicesContainer');
      const index = container.children.length;
      container.appendChild(createServiceField({name: '', description: '', price: '', image: ''}, index));
      refreshServiceNumbers();
    }

    function removeService(button) {
      if (document.getElementById('servicesContainer').children.length <= 1) {
        alert('You need at least one service!');
        return;
      }
      button.closest('.service-card').remove();
      refreshServiceNumbers();
    }

    async function pickHeroImage(type) {
      const fileInput = document.getElementById('heroImageFile');
      const imageInput = document.getElementById('heroImage');
      
      if (type === 'camera' || type === 'gallery') {
        fileInput.setAttribute('capture', type === 'camera' ? 'environment' : 'user');
        fileInput.click();
        fileInput.onchange = async (e) => {
          const file = e.target.files[0];
          if (file) {
            // Show uploading status
            imageInput.value = `[Uploading ${file.name}...]`;
            imageInput.style.color = '#94a3b8';
            
            try {
              // Upload to server
              const formData = new FormData();
              formData.append('image', file);
              
              const token = await getAdminToken();
              const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                body: formData
              });
              
              if (!response.ok) {
                throw new Error('Upload failed');
              }
              
              const result = await response.json();
              
              // Update image input with server URL
              imageInput.value = result.url;
              imageInput.style.color = '#1f2937';
              
              // Trigger preview update
              updatePreview();
              
            } catch (error) {
              console.error('Upload error:', error);
              imageInput.value = '';
              imageInput.style.color = '#ef4444';
              alert('Failed to upload image. Please try again or use a URL.');
            }
          }
        };
      } else if (type === 'url') {
        imageInput.focus();
      }
    }

    function openImageUpload() {
      // Legacy function - can be removed
      pickHeroImage('url');
    }

    async function finishSetup() {
      // Collect all data (no validation required - user can change everything after launch)
      const businessData = {
        businessName: document.getElementById('businessName').value,
        heroTitle: document.getElementById('heroTitle').value,
        heroSubtitle: document.getElementById('heroSubtitle').value,
        heroImage: document.getElementById('heroImage').value,
        email: document.getElementById('contactEmail').value,
        phone: document.getElementById('contactPhone').value,
        address: document.getElementById('contactAddress').value,
        businessHours: document.getElementById('businessHours').value,
        websiteUrl: document.getElementById('websiteUrl').value,
        facebookUrl: document.getElementById('facebookUrl').value,
        instagramUrl: document.getElementById('instagramUrl').value,
        googleMapsUrl: document.getElementById('googleMapsUrl').value,
        services: [],
        templateSpecific: {}
      };
      
      // Collect services
      const serviceFields = document.querySelectorAll('#servicesContainer > .form-group');
      serviceFields.forEach(field => {
        const service = {
          name: field.querySelector('.service-name').value,
          description: field.querySelector('.service-description').value,
          price: field.querySelector('.service-price').value,
          image: field.querySelector('.service-image').value
        };
        
        if (service.name) {
          businessData.services.push(service);
        }
      });
      
      // Collect template-specific data
      const templateSpecificFields = document.querySelectorAll('#templateSpecificContent input, #templateSpecificContent select, #templateSpecificContent textarea');
      templateSpecificFields.forEach(field => {
        if (field.type === 'checkbox') {
          businessData.templateSpecific[field.id] = field.checked;
        } else {
          businessData.templateSpecific[field.id] = field.value;
        }
      });
      
      console.log('Business data collected:', businessData);
      
      // Send data to server as draft (no payment required)
      try {
        console.log('Saving draft...', { templateId: selectedTemplate.id, businessData });
        
        const response = await fetch('/api/drafts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            templateId: selectedTemplate.id,
            businessData: businessData
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          throw new Error(`Server error: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Draft saved:', result);
        
        if (result.success) {
          // Show success message with preview link
          document.getElementById('step2').style.display = 'none';
          
          // Create success message HTML dynamically
          const successDiv = document.getElementById('success');
          successDiv.innerHTML = `
            <div class="success-message">
              <div class="success-icon">‚úÖ</div>
              <h2>Draft Saved!</h2>
              <p class="muted">Your site has been saved as a draft. You can preview it or publish it anytime.</p>
              <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="${result.previewUrl}" target="_blank" class="btn btn-secondary-large">üëÅÔ∏è Preview Draft</a>
                <button onclick="showPaymentModal()" class="btn btn-primary-large">üöÄ Publish Now</button>
              </div>
              <p style="margin-top: 20px; font-size: 0.9rem; color: #64748b;">Draft expires: ${new Date(result.expiresAt).toLocaleDateString()}</p>
            </div>
          `;
          successDiv.style.display = 'block';
          
          // Store draft ID for payment modal
          window.currentDraftId = result.draftId;
        } else {
          alert('Failed to save your draft. Please try again.');
        }
      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save your draft: ' + error.message);
      }
    }

    function showPaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closePaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    // Update existing site (edit mode)
    async function updateExistingSite(subdomain) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Please log in to update your site');
          window.location.href = '/login.html';
          return;
        }
        
        // Close payment modal if open
        closePaymentModal();
        
        // Show loading message
        const successDiv = document.getElementById('success');
        successDiv.style.display = 'block';
        successDiv.innerHTML = `
          <div class="success-message">
            <div class="success-icon">‚è≥</div>
            <h2>Updating Your Site...</h2>
            <p class="muted">Please wait while we save your changes.</p>
          </div>
        `;
        successDiv.scrollIntoView({ behavior: 'smooth' });
        
        // Collect current form data (similar to draft saving logic)
        const businessData = {};
        businessData.businessName = document.getElementById('businessName')?.value || '';
        businessData.heroTitle = document.getElementById('heroTitle')?.value || '';
        businessData.heroSubtitle = document.getElementById('heroSubtitle')?.value || '';
        businessData.heroImage = document.getElementById('heroImage')?.value || '';
        businessData.email = document.getElementById('email')?.value || '';
        businessData.phone = document.getElementById('phone')?.value || '';
        businessData.address = document.getElementById('address')?.value || '';
        businessData.hours = document.getElementById('hours')?.value || '';
        businessData.website = document.getElementById('website')?.value || '';
        businessData.facebook = document.getElementById('facebook')?.value || '';
        businessData.instagram = document.getElementById('instagram')?.value || '';
        businessData.maps = document.getElementById('maps')?.value || '';
        
        // Collect services
        const services = [];
        const serviceItems = document.querySelectorAll('#servicesList .service-item');
        serviceItems.forEach(item => {
          const name = item.querySelector('input[placeholder="Service name"]')?.value;
          const description = item.querySelector('input[placeholder="Description"]')?.value;
          const price = item.querySelector('input[placeholder="Price"]')?.value;
          const image = item.querySelector('input[placeholder="Image URL"]')?.value;
          if (name) {
            services.push({ name, description, price, image });
          }
        });
        businessData.services = services;
        
        // Collect template-specific data
        businessData.templateSpecific = {};
        const templateSpecificFields = document.querySelectorAll('#templateSpecificContent input, #templateSpecificContent select, #templateSpecificContent textarea');
        templateSpecificFields.forEach(field => {
          if (field.type === 'checkbox') {
            businessData.templateSpecific[field.id] = field.checked;
          } else {
            businessData.templateSpecific[field.id] = field.value;
          }
        });
        
        // Build the updated site structure (this mimics the publish endpoint logic)
        // Load the template to get the base structure
        const templateResponse = await fetch(`/data/templates/${selectedTemplate.id}.json`);
        const templateData = await templateResponse.json();
        
        const updatedSite = {
          templateId: selectedTemplate.id,
          brand: {
            name: businessData.businessName,
            logo: businessData.heroImage || templateData.brand?.logo
          },
          hero: {
            title: businessData.heroTitle,
            subtitle: businessData.heroSubtitle,
            image: businessData.heroImage,
            cta: templateData.hero?.cta || { text: 'Get Started', link: '#contact' }
          },
          contact: {
            email: businessData.email,
            phone: businessData.phone,
            address: businessData.address,
            hours: businessData.hours
          },
          social: {
            website: businessData.website,
            facebook: businessData.facebook,
            instagram: businessData.instagram,
            maps: businessData.maps
          },
          ...templateData
        };
        
        // Add services
        if (businessData.services && businessData.services.length > 0) {
          if (updatedSite.products) {
            updatedSite.products = businessData.services.map(s => ({
              name: s.name,
              price: parseFloat(s.price) || 0,
              description: s.description || '',
              ...(s.image && { image: s.image })
            }));
          } else if (updatedSite.services) {
            updatedSite.services.items = businessData.services.map(s => ({
              title: s.name,
              description: s.description || '',
              ...(s.price && { price: s.price }),
              ...(s.image && { image: s.image })
            }));
          }
        }
        
        // Add custom fields
        updatedSite.custom = businessData.templateSpecific;
        
        // Call the update endpoint
        const response = await fetch(`/api/sites/${subdomain}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updatedSite)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to update site');
        }
        
        // Show success message
        successDiv.innerHTML = `
          <div class="success-message">
            <div class="success-icon">‚úÖ</div>
            <h2>Site Updated Successfully!</h2>
            <p class="muted">Your changes are now live.</p>
            
            <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
              <p style="margin-bottom: 10px;"><strong>üåê Your Site URL:</strong></p>
              <input type="text" id="siteUrl" value="${window.location.origin}/sites/${subdomain}/" readonly style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1.1rem; text-align: center; background: white; color: #1f2937;">
              <button onclick="copyUrl()" style="margin-top: 15px; padding: 12px 24px; background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                üìã Copy URL
              </button>
            </div>
            
            <div style="margin-top: 30px;">
              <a href="/sites/${subdomain}/" target="_blank" style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #10b981, #059669); color: white; text-decoration: none; border-radius: 10px; font-weight: 600; margin-right: 10px;">
                üåê View Your Site
              </a>
              <a href="/dashboard.html" style="display: inline-block; padding: 14px 32px; background: #f1f5f9; color: #475569; text-decoration: none; border-radius: 10px; font-weight: 600;">
                üìä Go to Dashboard
              </a>
            </div>
          </div>
        `;
        
        console.log('Site updated successfully:', result);
        
      } catch (error) {
        console.error('Update error:', error);
        const successDiv = document.getElementById('success');
        successDiv.style.display = 'block';
        successDiv.innerHTML = `
          <div class="success-message" style="border-left: 4px solid #ef4444;">
            <div class="success-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">‚ùå</div>
            <h2 style="color: #dc2626;">Update Failed</h2>
            <p class="muted">${error.message || 'Failed to update your site. Please try again.'}</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              Try Again
            </button>
          </div>
        `;
      }
    }

    async function processPayment() {
      // Check if we're in edit mode
      const publishBtn = document.querySelector('.publish-btn');
      const isEditMode = publishBtn?.dataset.editMode === 'true';
      const subdomain = publishBtn?.dataset.subdomain;
      
      if (isEditMode && subdomain) {
        // Update existing site instead of publishing
        return await updateExistingSite(subdomain);
      }
      
      const email = document.getElementById('paymentEmail').value;
      const plan = document.querySelector('input[name="plan"]:checked').value;
      const draftId = window.currentDraftId;
      
      if (!email) {
        alert('Please enter your email address.');
        return;
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('Please enter a valid email address.');
        return;
      }
      
      console.log('Processing payment for draft:', draftId, 'plan:', plan);
      
      // Show loading state
      const payButton = document.querySelector('#paymentModal button[onclick="processPayment()"]');
      const originalText = payButton.textContent;
      payButton.textContent = 'Processing...';
      payButton.disabled = true;
      
      try {
        // If it's a paid plan (starter or pro), redirect to Stripe Checkout
        if (plan.toLowerCase() === 'starter' || plan.toLowerCase() === 'pro') {
          const token = localStorage.getItem('token');
          if (!token) {
            alert('Please log in to subscribe to a paid plan.');
            payButton.textContent = originalText;
            payButton.disabled = false;
            return;
          }
          
          // Create Stripe checkout session
          const checkoutResponse = await fetch('/api/create-subscription-checkout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              plan: plan.toLowerCase(),
              draftId: draftId
            })
          });
          
          const checkoutResult = await checkoutResponse.json();
          
          if (!checkoutResponse.ok) {
            throw new Error(checkoutResult.error || 'Failed to create checkout session');
          }
          
          // Store draft ID and email in localStorage for post-checkout processing
          localStorage.setItem('pendingPublish', JSON.stringify({
            draftId,
            email,
            plan
          }));
          
          // Redirect to Stripe Checkout
          console.log('Redirecting to Stripe Checkout...');
          window.location.href = checkoutResult.url;
          return;
        }
        
        // For free plan, proceed directly to publishing
        console.log('Publishing site for plan:', plan);
        
        // Call publish endpoint
        const response = await fetch(`/api/drafts/${draftId}/publish`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            plan: plan,
            email: email
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Close payment modal
          closePaymentModal();
          
          // Show success message
          const successDiv = document.getElementById('success');
          successDiv.innerHTML = `
            <div class="success-message">
              <div class="success-icon">üéâ</div>
              <h2>Your Site is Live!</h2>
              <p class="muted">Congratulations, ${result.businessName}! Your website has been published successfully.</p>
              
              <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                <p style="margin-bottom: 10px;"><strong>üåê Your Site URL:</strong></p>
                <input type="text" id="siteUrl" value="${result.url}" readonly style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1.1rem; text-align: center; background: white; color: #1f2937;">
                <button onclick="copySuccessUrl()" style="margin-top: 10px; width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                  üìã Copy URL
                </button>
              </div>
              
              <div style="margin-top: 25px; padding: 20px; background: #dbeafe; border-radius: 12px; border-left: 4px solid #3b82f6;">
                <p style="margin: 0 0 10px 0; font-weight: 600; color: #1e40af;"><strong>‚úì What's Included:</strong></p>
                <ul style="margin: 0; padding-left: 20px; color: #1e40af;">
                  ${result.whatsIncluded.map(f => `<li>${f}</li>`).join('')}
                </ul>
              </div>
              
              <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="${result.url}" target="_blank" class="btn btn-primary-large">üîó Visit Your Site</a>
                <button onclick="shareSuccess()" class="btn btn-secondary-large">üì§ Share Your Site</button>
                <a href="/dashboard.html" class="btn btn-secondary-large">üìä Dashboard</a>
              </div>
              
              <p style="margin-top: 25px; font-size: 0.85rem; color: #64748b; text-align: center;">
                üí° <strong>Tip:</strong> Add your business hours, social media links, and more by editing your site!
              </p>
            </div>
          `;
          successDiv.style.display = 'block';
          
          // Store URL for copy/share functions
          window.publishedSiteUrl = result.url;
          window.publishedBusinessName = result.businessName;
          
        } else {
          alert('Failed to publish your site. Please try again.');
          payButton.textContent = originalText;
          payButton.disabled = false;
        }
        
      } catch (error) {
        console.error('Publish error:', error);
        alert('Failed to publish your site: ' + error.message);
        payButton.textContent = originalText;
        payButton.disabled = false;
      }
    }

    // Success screen helper functions
    function copySuccessUrl() {
      const urlInput = document.getElementById('siteUrl');
      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // For mobile
      
      navigator.clipboard.writeText(urlInput.value).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#10b981';
        }, 2000);
      }).catch(() => {
        // Fallback
        urlInput.select();
        document.execCommand('copy');
        alert('URL copied to clipboard!');
      });
    }

    function shareSuccess() {
      const url = window.publishedSiteUrl;
      const title = `Check out ${window.publishedBusinessName} website!`;
      
      if (navigator.share) {
        navigator.share({
          title: title,
          text: `Check out this website!`,
          url: url,
        }).catch(err => {
          if (err.name !== 'AbortError') {
            console.error('Share error:', err);
          }
        });
      } else {
        // Fallback to copy
        copySuccessUrl();
      }
    }

    // Functions are now global since script is not a module
  </script>
</body>
</html>
