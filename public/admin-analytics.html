<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Analytics | SiteSprintz</title>
  <link rel="stylesheet" href="theme.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .admin-analytics-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 30px;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(220, 38, 38, 0.3);
    }
    
    .admin-header h1 {
      margin: 0;
      font-size: 2.2rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .admin-header p {
      margin: 8px 0 0 0;
      opacity: 0.9;
      font-size: 1rem;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    
    .metrics-section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card.highlight {
      border-color: #dc2626;
      box-shadow: 0 4px 20px rgba(220, 38, 38, 0.1);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }
    
    .stat-card.users::before { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .stat-card.sites::before { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-card.revenue::before { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-card.growth::before { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    }
    
    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.9;
    }
    
    .stat-value {
      font-size: 2.8rem;
      font-weight: bold;
      color: #1f2937;
      margin: 12px 0;
      line-height: 1;
    }
    
    .stat-label {
      color: #64748b;
      font-size: 0.95rem;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .stat-sublabel {
      color: #9ca3af;
      font-size: 0.8rem;
      margin-top: 8px;
    }
    
    .stat-change {
      font-size: 0.85rem;
      margin-top: 10px;
      font-weight: 600;
    }
    
    .stat-change.positive {
      color: #10b981;
    }
    
    .stat-change.negative {
      color: #ef4444;
    }
    
    .charts-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .chart-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
    }
    
    .chart-filter {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: white;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    .chart-placeholder {
      height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f9fafb, #f3f4f6);
      border-radius: 8px;
      color: #64748b;
      font-size: 0.9rem;
      text-align: center;
      padding: 20px;
    }
    
    .data-table-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .table-header {
      padding: 20px 24px;
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .table-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: #f9fafb;
      padding: 14px 24px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      font-size: 0.9rem;
    }
    
    .data-table td {
      padding: 14px 24px;
      border-bottom: 1px solid #f3f4f6;
      color: #1f2937;
      font-size: 0.9rem;
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tbody tr:hover {
      background: #f9fafb;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge-info {
      background: #dbeafe;
      color: #1e3a8a;
    }
    
    .loading {
      text-align: center;
      padding: 80px 20px;
      color: #64748b;
    }
    
    .loading-spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #dc2626;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .system-health {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    
    .health-item {
      padding: 15px;
      border-left: 4px solid #10b981;
      background: #f9fafb;
      border-radius: 6px;
    }
    
    .health-item.warning {
      border-left-color: #f59e0b;
    }
    
    .health-item.error {
      border-left-color: #ef4444;
    }
    
    .health-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 5px;
    }
    
    .health-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
    }
    
    @media (max-width: 1024px) {
      .charts-row {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .header-actions {
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="admin-analytics-container">
    <div class="admin-header">
      <div>
        <h1>üéØ Admin Analytics Dashboard</h1>
        <p id="lastUpdated">Real-time platform metrics and insights</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='/admin-users.html'">üë• Users</button>
        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">‚Üê Dashboard</button>
        <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
      </div>
    </div>
    
    <!-- System Health -->
    <div class="metrics-section">
      <h2 class="section-title">‚ö° System Health</h2>
      <div class="system-health" id="systemHealth">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading system health...</p>
        </div>
      </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="metrics-section">
      <h2 class="section-title">üìä Platform Overview</h2>
      <div class="stats-grid" id="platformStats">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading platform metrics...</p>
        </div>
      </div>
    </div>
    
    <!-- Growth Metrics -->
    <div class="metrics-section">
      <h2 class="section-title">üìà Growth Metrics</h2>
      <div class="stats-grid" id="growthStats">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="metrics-section">
      <h2 class="section-title">üìâ Trends & Insights</h2>
      <div class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">User Growth</h3>
            <select class="chart-filter" id="userGrowthFilter" onchange="updateChart('userGrowth')">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="365">Last Year</option>
            </select>
          </div>
          <div class="chart-placeholder">
            üìà User registration trends over time<br>
            <small>Integration with Chart.js recommended</small>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Revenue Trends</h3>
            <select class="chart-filter" id="revenueFilter" onchange="updateChart('revenue')">
              <option value="30" selected>Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="365">Last Year</option>
            </select>
          </div>
          <div class="chart-placeholder">
            üí∞ Monthly recurring revenue (MRR)<br>
            <small>Stripe integration data</small>
          </div>
        </div>
      </div>
      
      <div class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Template Popularity</h3>
          </div>
          <div class="chart-placeholder">
            üé® Most used templates<br>
            <small>Bar chart showing template usage</small>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Conversion Funnel</h3>
          </div>
          <div class="chart-placeholder">
            üéØ Visitor ‚Üí Signup ‚Üí Publish ‚Üí Payment<br>
            <small>Funnel visualization</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="metrics-section">
      <h2 class="section-title">üîî Recent Activity</h2>
      <div class="data-table-card">
        <div class="table-header">
          <h3 class="table-title">Latest User Signups</h3>
        </div>
        <div id="recentSignups">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading recent signups...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Top Users -->
    <div class="metrics-section">
      <div class="data-table-card">
        <div class="table-header">
          <h3 class="table-title">Top Users by Sites</h3>
        </div>
        <div id="topUsers">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading top users...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let adminAnalytics = null;
    
    // Check authentication and admin access
    async function checkAuth() {
      const token = localStorage.getItem('authToken');
      
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          currentUser = await response.json();
          
          // Check if user is admin
          if (currentUser.role !== 'admin') {
            alert('Admin access required');
            window.location.href = '/dashboard.html';
            return;
          }
          
          loadAdminAnalytics();
        } else {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
      }
    }
    
    // Load admin analytics
    async function loadAdminAnalytics() {
      try {
        const response = await fetch('/api/admin/analytics', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });
        
        if (response.ok) {
          adminAnalytics = await response.json();
          renderSystemHealth(adminAnalytics.system);
          renderPlatformStats(adminAnalytics.platform);
          renderGrowthStats(adminAnalytics.growth);
          renderRecentSignups(adminAnalytics.recentSignups);
          renderTopUsers(adminAnalytics.topUsers);
          updateLastUpdated();
        } else {
          showError('Failed to load analytics');
        }
      } catch (error) {
        console.error('Error loading analytics:', error);
        showError('Failed to load analytics');
      }
    }
    
    // Render system health
    function renderSystemHealth(system) {
      const container = document.getElementById('systemHealth');
      
      container.innerHTML = `
        <div class="health-item">
          <div class="health-label">Server Status</div>
          <div class="health-value">‚úÖ ${system.status || 'Online'}</div>
        </div>
        <div class="health-item">
          <div class="health-label">Uptime</div>
          <div class="health-value">${system.uptime || '99.9%'}</div>
        </div>
        <div class="health-item ${system.responseTime > 500 ? 'warning' : ''}">
          <div class="health-label">Avg Response</div>
          <div class="health-value">${system.responseTime || '120'}ms</div>
        </div>
        <div class="health-item">
          <div class="health-label">Active Users</div>
          <div class="health-value">${system.activeUsers || 0}</div>
        </div>
        <div class="health-item">
          <div class="health-label">Total Requests</div>
          <div class="health-value">${formatNumber(system.totalRequests || 0)}</div>
        </div>
      `;
    }
    
    // Render platform stats
    function renderPlatformStats(platform) {
      const container = document.getElementById('platformStats');
      
      const stats = [
        {
          icon: 'üë•',
          value: platform.totalUsers || 0,
          label: 'Total Users',
          sublabel: `${platform.activeUsers || 0} active`,
          change: platform.userGrowth || 0,
          className: 'users'
        },
        {
          icon: 'üåê',
          value: platform.totalSites || 0,
          label: 'Total Sites',
          sublabel: `${platform.publishedSites || 0} published`,
          change: platform.siteGrowth || 0,
          className: 'sites'
        },
        {
          icon: 'üí∞',
          value: `$${formatNumber(platform.totalRevenue || 0)}`,
          label: 'Total Revenue',
          sublabel: `$${formatNumber(platform.mrr || 0)} MRR`,
          change: platform.revenueGrowth || 0,
          className: 'revenue highlight'
        },
        {
          icon: 'üìä',
          value: `${platform.conversionRate || 0}%`,
          label: 'Conversion Rate',
          sublabel: 'Signup to publish',
          change: platform.conversionChange || 0,
          className: 'growth'
        }
      ];
      
      container.innerHTML = stats.map(stat => `
        <div class="stat-card ${stat.className}">
          <div class="stat-icon">${stat.icon}</div>
          <div class="stat-label">${stat.label}</div>
          <div class="stat-value">${stat.value}</div>
          <div class="stat-sublabel">${stat.sublabel}</div>
          ${stat.change ? `
            <div class="stat-change ${stat.change >= 0 ? 'positive' : 'negative'}">
              ${stat.change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stat.change)}% this month
            </div>
          ` : ''}
        </div>
      `).join('');
    }
    
    // Render growth stats
    function renderGrowthStats(growth) {
      const container = document.getElementById('growthStats');
      
      const stats = [
        {
          icon: 'üìÖ',
          value: growth.signupsThisMonth || 0,
          label: 'Signups This Month',
          sublabel: `${growth.signupsToday || 0} today`
        },
        {
          icon: 'üöÄ',
          value: growth.publishesThisMonth || 0,
          label: 'Sites Published',
          sublabel: `${growth.publishesToday || 0} today`
        },
        {
          icon: 'üí≥',
          value: growth.paymentsThisMonth || 0,
          label: 'Payments This Month',
          sublabel: `$${formatNumber(growth.revenueThisMonth || 0)}`
        },
        {
          icon: '‚≠ê',
          value: `${growth.activationRate || 0}%`,
          label: 'Activation Rate',
          sublabel: 'Users who publish'
        }
      ];
      
      container.innerHTML = stats.map(stat => `
        <div class="stat-card">
          <div class="stat-icon">${stat.icon}</div>
          <div class="stat-label">${stat.label}</div>
          <div class="stat-value">${stat.value}</div>
          <div class="stat-sublabel">${stat.sublabel}</div>
        </div>
      `).join('');
    }
    
    // Render recent signups
    function renderRecentSignups(signups) {
      const container = document.getElementById('recentSignups');
      
      if (!signups || signups.length === 0) {
        container.innerHTML = '<div class="loading"><p>No recent signups</p></div>';
        return;
      }
      
      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Sites</th>
              <th>Signup Date</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody>
            ${signups.slice(0, 10).map(user => `
              <tr>
                <td><strong>${user.email}</strong></td>
                <td><span class="status-badge badge-info">${user.role}</span></td>
                <td><span class="status-badge ${user.status === 'active' ? 'badge-success' : 'badge-warning'}">${user.status}</span></td>
                <td>${user.sitesCount || 0}</td>
                <td>${new Date(user.createdAt).toLocaleString()}</td>
                <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    // Render top users
    function renderTopUsers(users) {
      const container = document.getElementById('topUsers');
      
      if (!users || users.length === 0) {
        container.innerHTML = '<div class="loading"><p>No users yet</p></div>';
        return;
      }
      
      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Email</th>
              <th>Sites</th>
              <th>Published</th>
              <th>Drafts</th>
              <th>Plan</th>
              <th>Member Since</th>
            </tr>
          </thead>
          <tbody>
            ${users.slice(0, 20).map((user, index) => `
              <tr>
                <td><strong>#${index + 1}</strong></td>
                <td>${user.email}</td>
                <td><strong>${user.totalSites}</strong></td>
                <td><span class="status-badge badge-success">${user.publishedSites}</span></td>
                <td><span class="status-badge badge-warning">${user.draftSites}</span></td>
                <td><span class="status-badge badge-info">${user.plan || 'Free'}</span></td>
                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    // Helper functions
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }
    
    function updateLastUpdated() {
      const now = new Date();
      document.getElementById('lastUpdated').textContent = 
        `Last updated: ${now.toLocaleString()}`;
    }
    
    function refreshData() {
      loadAdminAnalytics();
    }
    
    function updateChart(chartType) {
      console.log('Updating chart:', chartType);
      // TODO: Implement chart updates with selected filters
    }
    
    function showError(message) {
      const container = document.getElementById('platformStats');
      container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 60px; background: white; border-radius: 12px; border: 2px solid #fecaca;">
          <div style="font-size: 4rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
          <h3 style="color: #dc2626; margin-bottom: 10px;">${message}</h3>
          <button class="btn" style="margin-top: 20px; background: #dc2626; color: white;" onclick="refreshData()">Try Again</button>
        </div>
      `;
    }
    
    // Initialize
    checkAuth();
    
    // Auto-refresh every 60 seconds
    setInterval(() => {
      loadAdminAnalytics();
    }, 60000);
  </script>
</body>
</html>

